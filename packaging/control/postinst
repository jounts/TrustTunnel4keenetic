#!/bin/sh
set -e

INSTALL_DIR="/opt/trusttunnel_client"

# Create default configs if not present
if [ ! -f "$INSTALL_DIR/mode.conf" ]; then
    cat > "$INSTALL_DIR/mode.conf" << 'EOF'
TT_MODE="socks5"
TUN_IDX="0"
PROXY_IDX="0"
HC_ENABLED="yes"
HC_INTERVAL="30"
HC_FAIL_THRESHOLD="3"
HC_GRACE_PERIOD="60"
HC_TARGET_URL="http://connectivitycheck.gstatic.com/generate_204"
HC_CURL_TIMEOUT="5"
HC_SOCKS5_PROXY="127.0.0.1:1080"
SR_ENABLED="no"
SR_HOME_COUNTRY="RU"
SR_DNS_PORT="5354"
SR_DNS_UPSTREAM="1.1.1.1"
EOF
fi

if [ ! -f "$INSTALL_DIR/manager.conf" ]; then
    cat > "$INSTALL_DIR/manager.conf" << 'EOF'
LISTEN_ADDR=":8080"
USERNAME="admin"
PASSWORD=""
EOF
fi

# Create required directories
mkdir -p /opt/var/run /opt/var/log
mkdir -p "$INSTALL_DIR/routing"
mkdir -p /opt/etc/dnsmasq.d

# Make scripts executable
chmod 755 /opt/etc/init.d/S98trusttunnel-manager 2>/dev/null || true
chmod 755 /opt/etc/init.d/S99trusttunnel 2>/dev/null || true
chmod 755 "$INSTALL_DIR/trusttunnel-manager" 2>/dev/null || true
chmod 755 "$INSTALL_DIR/smart-routing.sh" 2>/dev/null || true

# Make NDM hooks executable
for hook in /opt/etc/ndm/wan.d/010-trusttunnel.sh \
            /opt/etc/ndm/iflayerchanged.d/trusttunnel.sh \
            /opt/etc/ndm/netfilter.d/trusttunnel.sh \
            /opt/etc/ndm/schedule.d/trusttunnel.sh \
            /opt/etc/ndm/button.d/trusttunnel.sh; do
    chmod 755 "$hook" 2>/dev/null || true
done

# Download TrustTunnel client binary if not present
if [ ! -f "$INSTALL_DIR/trusttunnel_client" ]; then
    echo "TrustTunnel client binary not found."
    echo "Please install it manually or run: $INSTALL_DIR/configure.sh"
fi

echo ""
echo "TrustTunnel Manager installed successfully!"
echo ""
echo "Configure: vi $INSTALL_DIR/trusttunnel_client.toml"
echo "Start:     /opt/etc/init.d/S98trusttunnel-manager start"
echo "           /opt/etc/init.d/S99trusttunnel start"
echo "Web panel: http://<router-ip>:8080"

exit 0
